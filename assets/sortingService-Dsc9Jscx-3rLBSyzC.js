import{O as n,K as c,v as d}from"./index-Cx51dYQZ.js";var m=Object.defineProperty,b=Object.defineProperties,v=Object.getOwnPropertyDescriptors,f=Object.getOwnPropertySymbols,S=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable,y=(l,e,r)=>e in l?m(l,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):l[e]=r,g=(l,e)=>{for(var r in e||(e={}))S.call(e,r)&&y(l,r,e[r]);if(f)for(var r of f(e))E.call(e,r)&&y(l,r,e[r]);return l},p=(l,e)=>b(l,v(e)),o=(l,e,r)=>new Promise((t,s)=>{var i=a=>{try{u(r.next(a))}catch(_){s(_)}},h=a=>{try{u(r.throw(a))}catch(_){s(_)}},u=a=>a.done?t(a.value):Promise.resolve(a.value).then(i,h);u((r=r.apply(l,e)).next())});class z{getSizeClassThresholds(){return o(this,null,function*(){try{const{data:e,error:r}=yield n(()=>o(this,null,function*(){return yield c.from("size_class_thresholds").select("*").eq("is_active",!0).order("class_number")}));return r?(console.warn("Permission denied for size_class_thresholds, returning empty array"),[]):e||[]}catch(e){return console.warn("Error fetching size class thresholds:",e),[]}})}updateSizeClassThresholds(e){return o(this,null,function*(){try{const r=e.map(i=>p(g({},i),{updated_at:new Date().toISOString()})),{data:t,error:s}=yield n(()=>o(this,null,function*(){return yield c.from("size_class_thresholds").upsert(r).select()}));if(s)throw s;return t||[]}catch(r){throw new Error(d(r,"updating size class thresholds"))}})}getSizeClassForWeight(e){return o(this,null,function*(){try{const{data:r,error:t}=yield n(()=>o(this,null,function*(){return yield c.rpc("get_size_class_for_weight",{weight_grams:e})}));if(t)throw t;return r}catch(r){throw new Error(d(r,"determining size class for weight"))}})}createSortingBatch(e){return o(this,null,function*(){try{const{data:r,error:t}=yield n(()=>o(this,null,function*(){return yield c.rpc("create_sorting_batch",{p_processing_record_id:e.processing_record_id,p_batch_number:e.batch_number,p_sorted_by:null,p_storage_location_id:e.storage_location_id||null})}));if(t)throw t;const{data:s,error:i}=yield n(()=>o(this,null,function*(){return yield c.from("sorting_batches").select(`
            *,
            processing_record:processing_records(
              id,
              processing_date,
              post_processing_weight,
              ready_for_dispatch_count,
              processing_code
            )
          `).eq("id",r).single()}));if(i)throw i;return s}catch(r){throw new Error(d(r,"creating sorting batch"))}})}getSortingBatches(e){return o(this,null,function*(){try{let r=c.from("sorting_batches").select(`
          *,
          processing_record:processing_records(
            id,
            processing_date,
            post_processing_weight,
            ready_for_dispatch_count,
            processing_code,
            fish_type,
            grading_results,
            final_value,
            processing_yield,
            processing_waste,
            size_distribution,
            total_pieces,
            warehouse_entry:warehouse_entries(
              id,
              farmer_id,
              farmer:farmers(
                id,
                name,
                phone,
                location,
                rating
              )
            )
          )
        `).order("created_at",{ascending:!1});e!=null&&e.status&&(r=r.eq("status",e.status)),e!=null&&e.processing_record_id&&(r=r.eq("processing_record_id",e.processing_record_id)),e!=null&&e.date_from&&(r=r.gte("sorting_date",e.date_from)),e!=null&&e.date_to&&(r=r.lte("sorting_date",e.date_to));const t=(e==null?void 0:e.limit)||50;r=r.limit(t);const{data:s,error:i}=yield n(()=>o(this,null,function*(){return r}));if(i)throw i;return s||[]}catch(r){throw new Error(d(r,"fetching sorting batches"))}})}getSortingBatch(e){return o(this,null,function*(){try{const{data:r,error:t}=yield n(()=>o(this,null,function*(){return yield c.from("sorting_batches").select(`
            *,
            processing_record:processing_records(
              id,
              processing_date,
              post_processing_weight,
              ready_for_dispatch_count,
              processing_code,
              fish_type,
              grading_results,
              final_value,
              processing_yield,
              processing_waste,
              size_distribution,
              total_pieces,
              warehouse_entry:warehouse_entries(
                id,
                farmer_id,
                farmer:farmers(
                  id,
                  name,
                  phone,
                  location,
                  rating
                )
              )
            )
          `).eq("id",e).single()}));if(t)throw t;const{data:s,error:i}=yield n(()=>o(this,null,function*(){return yield c.from("sorting_results").select("*").eq("sorting_batch_id",e).order("size_class")}));if(i)throw i;return p(g({},r),{results:s||[]})}catch(r){throw new Error(d(r,"fetching sorting batch"))}})}addSortedFishItem(e){return o(this,null,function*(){try{const{data:r,error:t}=yield n(()=>o(this,null,function*(){return yield c.rpc("add_sorted_fish_item",{p_sorting_batch_id:e.sorting_batch_id,p_weight_grams:e.weight_grams,p_length_cm:e.length_cm,p_grade:e.grade,p_quality_notes:e.quality_notes,p_storage_location_id:e.storage_location_id||null})}));if(t)throw t;const{data:s,error:i}=yield n(()=>o(this,null,function*(){return yield c.from("sorted_fish_items").select("*").eq("id",r).single()}));if(i)throw i;return s}catch(r){throw new Error(d(r,"adding sorted fish item"))}})}updateSortingBatch(e,r){return o(this,null,function*(){try{const{data:t,error:s}=yield n(()=>o(this,null,function*(){return yield c.from("sorting_batches").update(p(g({},r),{updated_at:new Date().toISOString()})).eq("id",e).select(`
            *,
            processing_record:processing_records(
              id,
              processing_date,
              post_processing_weight,
              ready_for_dispatch_count,
              processing_code
            )
          `).single()}));if(s)throw s;return t}catch(t){throw new Error(d(t,"updating sorting batch"))}})}completeSortingBatch(e){return o(this,null,function*(){try{const{data:r,error:t}=yield n(()=>o(this,null,function*(){return yield c.rpc("complete_sorting_batch",{p_sorting_batch_id:e})}));if(t)throw t;return r}catch(r){throw new Error(d(r,"completing sorting batch"))}})}getSortingResultsForInventory(e){return o(this,null,function*(){try{const{data:r,error:t}=yield n(()=>o(this,null,function*(){return yield c.rpc("get_sorting_results_for_inventory",{p_sorting_batch_id:e})}));if(t)throw t;return r||[]}catch(r){throw new Error(d(r,"fetching sorting results for inventory"))}})}getSortingSummary(e){return o(this,null,function*(){try{const r=yield this.getSortingBatch(e),t={},s={};let i=0,h=0;r.results.forEach(a=>{t[a.size_class]={pieces:a.total_pieces,weight:a.total_weight_grams,average_weight:a.average_weight_grams},i+=a.total_pieces,h+=a.total_weight_grams,Object.entries(a.grade_distribution).forEach(([_,w])=>{s[_]=(s[_]||0)+w})});const u=r.total_pieces>0?Math.round(i/r.total_pieces*100):0;return{batch_id:r.id,batch_number:r.batch_number,total_items:i,total_weight:h,size_class_distribution:t,grade_distribution:s,completion_percentage:u}}catch(r){throw new Error(d(r,"generating sorting summary"))}})}validateProcessingRecordForSorting(e){return o(this,null,function*(){try{const{data:r,error:t}=yield n(()=>o(this,null,function*(){return yield c.from("processing_records").select("*").eq("id",e).single()}));if(t)throw t;if(!r)return{canSort:!1,reason:"Processing record not found"};const{data:s,error:i}=yield n(()=>o(this,null,function*(){return yield c.from("sorting_batches").select("id, status").eq("processing_record_id",e).eq("status","completed")}));if(i)throw i;return s&&s.length>0&&s[0]?{canSort:!1,reason:"Processing record already sorted"}:!r.post_processing_weight||r.post_processing_weight<=0?{canSort:!1,reason:"Invalid post-processing weight"}:!r.ready_for_dispatch_count||r.ready_for_dispatch_count<=0?{canSort:!1,reason:"No fish ready for dispatch"}:{canSort:!0,processingRecord:r}}catch(r){throw new Error(d(r,"validating processing record for sorting"))}})}getProcessingRecordsReadyForSorting(){return o(this,null,function*(){try{const{data:e,error:r}=yield n(()=>o(this,null,function*(){return yield c.from("processing_records").select(`
            *,
            warehouse_entry:warehouse_entries(
              id,
              entry_date,
              total_weight,
              farmer_id,
              entry_code,
              farmer:farmers(
                id,
                name,
                phone,
                location,
                rating
              )
            ),
            sorting_batches!left(
              id,
              status
            )
          `).gt("post_processing_weight",0).order("processing_date",{ascending:!1})}));if(r)throw r;return(e||[]).filter(t=>{var s;return!((s=t.sorting_batches)!=null&&s.some(i=>i.status==="completed"))})}catch(e){throw new Error(d(e,"fetching processing records ready for sorting"))}})}}const O=new z;export{O as R};
