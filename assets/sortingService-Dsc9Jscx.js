var f=Object.defineProperty,b=Object.defineProperties;var S=Object.getOwnPropertyDescriptors;var l=Object.getOwnPropertySymbols;var E=Object.prototype.hasOwnProperty,z=Object.prototype.propertyIsEnumerable;var y=(_,t,r)=>t in _?f(_,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):_[t]=r,w=(_,t)=>{for(var r in t||(t={}))E.call(t,r)&&y(_,r,t[r]);if(l)for(var r of l(t))z.call(t,r)&&y(_,r,t[r]);return _},u=(_,t)=>b(_,S(t));var s=(_,t,r)=>new Promise((e,o)=>{var a=n=>{try{g(r.next(n))}catch(p){o(p)}},h=n=>{try{g(r.throw(n))}catch(p){o(p)}},g=n=>n.done?e(n.value):Promise.resolve(n.value).then(a,h);g((r=r.apply(_,t)).next())});import{w as i,s as c,o as d}from"./index-CpNFiXA1.js";class q{getSizeClassThresholds(){return s(this,null,function*(){try{const{data:t,error:r}=yield i(()=>s(this,null,function*(){return yield c.from("size_class_thresholds").select("*").eq("is_active",!0).order("class_number")}));return r?(console.warn("Permission denied for size_class_thresholds, returning empty array"),[]):t||[]}catch(t){return console.warn("Error fetching size class thresholds:",t),[]}})}updateSizeClassThresholds(t){return s(this,null,function*(){try{const r=t.map(a=>u(w({},a),{updated_at:new Date().toISOString()})),{data:e,error:o}=yield i(()=>s(this,null,function*(){return yield c.from("size_class_thresholds").upsert(r).select()}));if(o)throw o;return e||[]}catch(r){throw new Error(d(r,"updating size class thresholds"))}})}getSizeClassForWeight(t){return s(this,null,function*(){try{const{data:r,error:e}=yield i(()=>s(this,null,function*(){return yield c.rpc("get_size_class_for_weight",{weight_grams:t})}));if(e)throw e;return r}catch(r){throw new Error(d(r,"determining size class for weight"))}})}createSortingBatch(t){return s(this,null,function*(){try{const{data:r,error:e}=yield i(()=>s(this,null,function*(){return yield c.rpc("create_sorting_batch",{p_processing_record_id:t.processing_record_id,p_batch_number:t.batch_number,p_sorted_by:null,p_storage_location_id:t.storage_location_id||null})}));if(e)throw e;const{data:o,error:a}=yield i(()=>s(this,null,function*(){return yield c.from("sorting_batches").select(`
            *,
            processing_record:processing_records(
              id,
              processing_date,
              post_processing_weight,
              ready_for_dispatch_count,
              processing_code
            )
          `).eq("id",r).single()}));if(a)throw a;return o}catch(r){throw new Error(d(r,"creating sorting batch"))}})}getSortingBatches(t){return s(this,null,function*(){try{let r=c.from("sorting_batches").select(`
          *,
          processing_record:processing_records(
            id,
            processing_date,
            post_processing_weight,
            ready_for_dispatch_count,
            processing_code,
            fish_type,
            grading_results,
            final_value,
            processing_yield,
            processing_waste,
            size_distribution,
            total_pieces,
            warehouse_entry:warehouse_entries(
              id,
              farmer_id,
              farmer:farmers(
                id,
                name,
                phone,
                location,
                rating
              )
            )
          )
        `).order("created_at",{ascending:!1});t!=null&&t.status&&(r=r.eq("status",t.status)),t!=null&&t.processing_record_id&&(r=r.eq("processing_record_id",t.processing_record_id)),t!=null&&t.date_from&&(r=r.gte("sorting_date",t.date_from)),t!=null&&t.date_to&&(r=r.lte("sorting_date",t.date_to));const e=(t==null?void 0:t.limit)||50;r=r.limit(e);const{data:o,error:a}=yield i(()=>s(this,null,function*(){return r}));if(a)throw a;return o||[]}catch(r){throw new Error(d(r,"fetching sorting batches"))}})}getSortingBatch(t){return s(this,null,function*(){try{const{data:r,error:e}=yield i(()=>s(this,null,function*(){return yield c.from("sorting_batches").select(`
            *,
            processing_record:processing_records(
              id,
              processing_date,
              post_processing_weight,
              ready_for_dispatch_count,
              processing_code,
              fish_type,
              grading_results,
              final_value,
              processing_yield,
              processing_waste,
              size_distribution,
              total_pieces,
              warehouse_entry:warehouse_entries(
                id,
                farmer_id,
                farmer:farmers(
                  id,
                  name,
                  phone,
                  location,
                  rating
                )
              )
            )
          `).eq("id",t).single()}));if(e)throw e;const{data:o,error:a}=yield i(()=>s(this,null,function*(){return yield c.from("sorting_results").select("*").eq("sorting_batch_id",t).order("size_class")}));if(a)throw a;return u(w({},r),{results:o||[]})}catch(r){throw new Error(d(r,"fetching sorting batch"))}})}addSortedFishItem(t){return s(this,null,function*(){try{const{data:r,error:e}=yield i(()=>s(this,null,function*(){return yield c.rpc("add_sorted_fish_item",{p_sorting_batch_id:t.sorting_batch_id,p_weight_grams:t.weight_grams,p_length_cm:t.length_cm,p_grade:t.grade,p_quality_notes:t.quality_notes,p_storage_location_id:t.storage_location_id||null})}));if(e)throw e;const{data:o,error:a}=yield i(()=>s(this,null,function*(){return yield c.from("sorted_fish_items").select("*").eq("id",r).single()}));if(a)throw a;return o}catch(r){throw new Error(d(r,"adding sorted fish item"))}})}updateSortingBatch(t,r){return s(this,null,function*(){try{const{data:e,error:o}=yield i(()=>s(this,null,function*(){return yield c.from("sorting_batches").update(u(w({},r),{updated_at:new Date().toISOString()})).eq("id",t).select(`
            *,
            processing_record:processing_records(
              id,
              processing_date,
              post_processing_weight,
              ready_for_dispatch_count,
              processing_code
            )
          `).single()}));if(o)throw o;return e}catch(e){throw new Error(d(e,"updating sorting batch"))}})}completeSortingBatch(t){return s(this,null,function*(){try{const{data:r,error:e}=yield i(()=>s(this,null,function*(){return yield c.rpc("complete_sorting_batch",{p_sorting_batch_id:t})}));if(e)throw e;return r}catch(r){throw new Error(d(r,"completing sorting batch"))}})}getSortingResultsForInventory(t){return s(this,null,function*(){try{const{data:r,error:e}=yield i(()=>s(this,null,function*(){return yield c.rpc("get_sorting_results_for_inventory",{p_sorting_batch_id:t})}));if(e)throw e;return r||[]}catch(r){throw new Error(d(r,"fetching sorting results for inventory"))}})}getSortingSummary(t){return s(this,null,function*(){try{const r=yield this.getSortingBatch(t),e={},o={};let a=0,h=0;r.results.forEach(n=>{e[n.size_class]={pieces:n.total_pieces,weight:n.total_weight_grams,average_weight:n.average_weight_grams},a+=n.total_pieces,h+=n.total_weight_grams,Object.entries(n.grade_distribution).forEach(([p,m])=>{o[p]=(o[p]||0)+m})});const g=r.total_pieces>0?Math.round(a/r.total_pieces*100):0;return{batch_id:r.id,batch_number:r.batch_number,total_items:a,total_weight:h,size_class_distribution:e,grade_distribution:o,completion_percentage:g}}catch(r){throw new Error(d(r,"generating sorting summary"))}})}validateProcessingRecordForSorting(t){return s(this,null,function*(){try{const{data:r,error:e}=yield i(()=>s(this,null,function*(){return yield c.from("processing_records").select("*").eq("id",t).single()}));if(e)throw e;if(!r)return{canSort:!1,reason:"Processing record not found"};const{data:o,error:a}=yield i(()=>s(this,null,function*(){return yield c.from("sorting_batches").select("id, status").eq("processing_record_id",t).eq("status","completed")}));if(a)throw a;return(o&&o.length>0?o[0]:null)?{canSort:!1,reason:"Processing record already sorted"}:!r.post_processing_weight||r.post_processing_weight<=0?{canSort:!1,reason:"Invalid post-processing weight"}:!r.ready_for_dispatch_count||r.ready_for_dispatch_count<=0?{canSort:!1,reason:"No fish ready for dispatch"}:{canSort:!0,processingRecord:r}}catch(r){throw new Error(d(r,"validating processing record for sorting"))}})}getProcessingRecordsReadyForSorting(){return s(this,null,function*(){try{const{data:t,error:r}=yield i(()=>s(this,null,function*(){return yield c.from("processing_records").select(`
            *,
            warehouse_entry:warehouse_entries(
              id,
              entry_date,
              total_weight,
              farmer_id,
              entry_code,
              farmer:farmers(
                id,
                name,
                phone,
                location,
                rating
              )
            ),
            sorting_batches!left(
              id,
              status
            )
          `).gt("post_processing_weight",0).order("processing_date",{ascending:!1})}));if(r)throw r;return(t||[]).filter(a=>{var g;return!((g=a.sorting_batches)==null?void 0:g.some(n=>n.status==="completed"))})}catch(t){throw new Error(d(t,"fetching processing records ready for sorting"))}})}}const R=new q;export{R as s};
