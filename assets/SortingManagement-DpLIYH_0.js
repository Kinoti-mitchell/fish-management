import{s as j,m as Pe,r as o,j as e,B as g,H as Oe,a as v,b as w,P as A,f as H,g as Y,n as he,F as E,k as Te,E as Be,l as G,L as _,I as Re,t as x}from"./main-F3q40TAH.js";import{C as xe,S as Ie,a as Ae,b as Ee,c as Le,d as $e}from"./select-BDoYxUW5.js";import{D as K,b as Q,c as J,d as X,e as Z}from"./dialog-CkI_bZ5S.js";import{T as qe}from"./textarea-Dn2zPVRL.js";import{s as L}from"./sortingService-D7neUQZS.js";import{i as Ue}from"./inventoryService-B2V_K8cL.js";import{generateUniqueBatchNumber as We}from"./entryCodeGenerator-CF-Dt-DR.js";import{R as ee}from"./refresh-cw-BE374wKn.js";import{C as $}from"./circle-alert-BWKr0XuS.js";import{C as y}from"./circle-check-big-BWLP4q_v.js";import{S as ue}from"./scale-BxtwfTXG.js";import{W as se}from"./weight-BDP6grDy.js";import{C as pe}from"./calendar-BkS01sXC.js";import{C as je}from"./index-CEX4zLXe.js";import{S as Me}from"./settings-MaJavPoU.js";import{S as Ve}from"./square-pen-gRqhOfXw.js";import"./index-yY-Pidxn.js";import"./index-DWnEPUXc.js";async function be(c){try{const{data:p,error:m}=await c;if(m){if(m.message&&m.message.includes("406")){console.warn("406 error detected, trying alternative query approach");const{data:q,error:u}=await j.from("sorting_batches").select("*").limit(1);return u?(console.error("Fallback query also failed:",u),{data:null,error:u}):(console.warn("Fallback query succeeded, original query structure may be problematic"),{data:null,error:new Error("Query structure incompatible with current RLS policies")})}return{data:p,error:m}}return{data:p,error:m}}catch(p){return console.error("Unexpected error in safeQuerySortingBatches:",p),{data:null,error:p}}}function He(c,p){if(console.error(`Supabase ${p} error:`,c),c&&typeof c=="object"){if(c.message&&c.message.includes("406"))return"Access denied. Please check your permissions or contact your administrator.";if(c.message&&c.message.includes("401"))return"Authentication required. Please log in again.";if(c.message&&c.message.includes("403"))return"Access forbidden. You do not have permission to perform this action.";if(c.message&&c.message.includes("JWT"))return"Authentication error. Please log in again.";if(c.message&&c.message.includes("relation")&&c.message.includes("does not exist"))return"Database table not found. Please contact your administrator.";if(c.message&&c.message.includes("permission denied"))return"Permission denied. Please check your user permissions.";if(c.message&&typeof c.message=="string")return c.message}return"An unexpected error occurred. Please try again."}const ms=({onNavigate:c})=>{const{user:p}=Pe(),[m,q]=o.useState([]),[u,te]=o.useState([]),[P,re]=o.useState([]),[U,O]=o.useState([]),[fe,ie]=o.useState(!1),[ae,ne]=o.useState(null),[le,ce]=o.useState(!1),[W,Ne]=o.useState(!1),[M,_e]=o.useState(!1),[V,f]=o.useState(!1),[ve,T]=o.useState(!1),[we,B]=o.useState(!1),[ye,R]=o.useState(!1),[n,oe]=o.useState(null),[r,de]=o.useState(null),[i,S]=o.useState({batch_number:"",size_distribution:{},total_weight_kg:0,remaining_weight_kg:0,notes:"",storage_location_id:""}),k=o.useCallback(async()=>{ie(!0),ne(null);try{console.log("🔄 Loading sorting data...");const[s,t,a]=await Promise.all([L.getSizeClassThresholds(),L.getSortingBatches({status:"completed",limit:20}),L.getProcessingRecordsReadyForSorting()]);console.log("📊 Data loaded:",{thresholds:s.length,batches:t.length,records:a.length}),re(s),te(t),q(a);try{const{data:l,error:h}=await j.from("storage_locations").select("*").eq("status","active").order("name");h?(console.warn("Could not fetch storage locations:",h.message),O([{id:"default-1",name:"Cold Storage A",capacity_kg:1e3,current_usage_kg:0,location_type:"cold_storage"},{id:"default-2",name:"Cold Storage B",capacity_kg:1e3,current_usage_kg:0,location_type:"cold_storage"}])):(console.log("🏪 Storage locations loaded:",l?.length||0),O(l||[]))}catch(l){console.warn("Error fetching storage locations:",l),O([{id:"default-1",name:"Cold Storage A",capacity_kg:1e3,current_usage_kg:0,location_type:"cold_storage"},{id:"default-2",name:"Cold Storage B",capacity_kg:1e3,current_usage_kg:0,location_type:"cold_storage"}])}}catch(s){console.error("❌ Error loading sorting data:",s),ne("Failed to load sorting data. Please try again."),re([]),te([]),q([]),O([])}finally{ie(!1)}},[]);o.useEffect(()=>{k()},[k]);const me=o.useCallback(async()=>{ce(!0),await k(),ce(!1)},[]),Se=o.useMemo(()=>u.reduce((s,t)=>s+(t.total_weight_grams?t.total_weight_grams/1e3:0),0),[u]);o.useMemo(()=>m.reduce((s,t)=>s+(t.post_processing_weight||0),0),[m]);const ke=async s=>{try{if(console.log("Starting sorting for record:",s.id),!p){console.error("No user found in AuthContext"),x.error("Please log in to continue.");return}console.log("User authenticated via AuthContext:",p.email);const t=j.from("sorting_batches").select("id, batch_number, status").eq("processing_record_id",s.id).eq("status","completed").maybeSingle(),{data:a,error:l}=await be(t);if(l){if(console.warn("Could not check for existing sorting batches:",l),l.message&&l.message.includes("406")){x.error("Access denied. Please check your permissions or contact your administrator.");return}if(l.message&&l.message.includes("relation")&&l.message.includes("does not exist")){x.error("Sorting functionality is not properly set up. Please contact your administrator.");return}console.warn("Continuing despite check error:",l.message)}if(a&&a.length>0){x.error(`This processing record has already been sorted! Batch: ${a[0].batch_number}`);return}oe(s);let h;try{h=await We()}catch(b){console.warn("Error generating batch number, using fallback:",b),h=`Batch${Date.now().toString().slice(-6)}`}const N=s.post_processing_weight||0;S({batch_number:h,size_distribution:{},total_weight_kg:N,remaining_weight_kg:N,notes:"",storage_location_id:""}),T(!0)}catch(t){console.error("Error starting sorting:",t);const a=He(t,"starting sorting");x.error(a)}},ze=(s,t)=>{const a={...i.size_distribution};t===0?delete a[s]:a[s]=t;const l=Object.values(a).reduce((N,b)=>N+b,0),h=i.total_weight_kg-l;S({...i,size_distribution:a,remaining_weight_kg:h})},Ce=async()=>{try{if(!n||V)return;if(f(!0),i.remaining_weight_kg!==0){x.error(`Please distribute all ${i.total_weight_kg}kg. ${i.remaining_weight_kg}kg remaining.`),f(!1);return}if(!i.storage_location_id){x.error("Please select a storage location"),f(!1);return}const s=j.from("sorting_batches").select("id, batch_number, status").eq("processing_record_id",n.id).eq("status","completed").maybeSingle(),{data:t,error:a}=await be(s);if(a&&(console.warn("Could not check for existing sorting batches:",a),a.message&&a.message.includes("406"))){x.error("Access denied. Please check your permissions or contact your administrator."),f(!1);return}if(t&&t.length>0){x.error(`This processing record has already been sorted! Batch: ${t[0].batch_number}`),f(!1);return}const{error:l}=await j.from("processing_records").update({size_distribution:i.size_distribution,updated_at:new Date().toISOString()}).eq("id",n.id);if(l)throw console.error("Error updating processing record:",l),l;const h=Object.values(i.size_distribution).reduce((C,d)=>C+(Number(d)||0),0),N={processing_record_id:n.id,batch_number:i.batch_number,notes:i.notes,status:"completed",total_pieces:h,total_weight_grams:i.total_weight_kg*1e3,sorting_date:new Date().toISOString().split("T")[0],storage_location_id:i.storage_location_id,size_distribution:i.size_distribution};console.log("Creating batch with size distribution:",N.size_distribution);const{data:b,error:z}=await j.from("sorting_batches").insert([N]).select("id").single();if(z){if(z.code==="23505"&&z.message.includes("sorting_batches_one_completed_per_processing_record")){x.error("This processing record has already been sorted! Please refresh the page to see the updated list."),await k(),f(!1);return}throw console.error("Error creating sorting batch:",z),z}if(b){const C=Object.entries(i.size_distribution).map(([d,I])=>{const D=Number(I)||0,F=D>0?i.total_weight_kg*1e3/h:0,Fe=D*F;return{sorting_batch_id:b.id,storage_location_id:i.storage_location_id,size_class:parseInt(d),total_pieces:D,total_weight_grams:Fe,average_weight_grams:F,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}}).filter(d=>d.total_pieces>0);if(C.length>0){const{error:d}=await j.from("sorting_results").insert(C);if(d)throw console.error("Error creating sorting results:",d),d;console.log("Created sorting results:",C.length,"size classes")}try{const{data:d,error:I}=await j.from("storage_locations").select("current_usage_kg").eq("id",i.storage_location_id).single();if(I)console.warn("Could not fetch current storage usage:",I);else{const D=(d.current_usage_kg||0)+i.total_weight_kg,{error:F}=await j.from("storage_locations").update({current_usage_kg:D,updated_at:new Date().toISOString()}).eq("id",i.storage_location_id);F?console.warn("Could not update storage location capacity:",F):console.log("Updated storage location capacity:",i.storage_location_id)}}catch(d){console.warn("Error updating storage capacity:",d)}try{await Ue.addStockFromSorting(b.id),console.log("Automatically added to inventory:",b.id)}catch(d){console.warn("Could not automatically add to inventory:",d),x.error("Sorting completed but failed to add to inventory. Please add manually from inventory management.")}}x.success("Fish sorted and batch created successfully!"),T(!1),oe(null),S({batch_number:"",size_distribution:{},total_weight_kg:0,remaining_weight_kg:0,notes:"",storage_location_id:""}),await k()}catch(s){x.error("Failed to complete sorting"),console.error("Sorting error:",s)}finally{f(!1)}},ge=()=>{B(!0)},De=async s=>{try{console.log("Viewing batch details:",s),console.log("Batch size distribution:",s.size_distribution);const t=await L.getSortingBatch(s.id);console.log("Fresh batch data:",t),de(t),R(!0)}catch(t){console.error("Error fetching fresh batch data:",t),de(s),R(!0)}};return e.jsx("div",{className:"min-h-screen bg-gray-50 content-container",children:e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6 responsive-padding",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Sorting Management"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Sort fish into size classes and manage sorting operations"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(g,{variant:"outline",onClick:me,disabled:le,className:"flex items-center gap-2",children:[e.jsx(ee,{className:`w-4 h-4 ${le?"animate-spin":""}`}),"Refresh"]}),e.jsxs(g,{onClick:()=>c("inventory"),className:"bg-green-600 hover:bg-green-700 text-white flex items-center gap-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),"Go to Inventory"]})]})]})}),ae&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{className:"w-5 h-5 text-red-600"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-red-800",children:"Error Loading Data"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:ae}),e.jsx(g,{onClick:me,variant:"outline",size:"sm",className:"mt-2",children:"Try Again"})]})]})}),!1,e.jsx("div",{className:"px-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx(v,{className:"bg-gradient-to-r from-blue-500 to-blue-600 text-white",children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-blue-100 text-sm font-medium",children:"Processing Records"}),e.jsx("p",{className:"text-3xl font-bold",children:m.length})]}),e.jsx(A,{className:"w-8 h-8 text-blue-200"})]})})}),e.jsx(v,{className:"bg-gradient-to-r from-green-500 to-green-600 text-white",children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-green-100 text-sm font-medium",children:"Total Sorted"}),e.jsxs("p",{className:"text-3xl font-bold",children:[Se.toFixed(1),"kg"]}),e.jsxs("p",{className:"text-green-200 text-xs mt-1",children:[u.length," batches"]})]}),e.jsx(y,{className:"w-8 h-8 text-green-200"})]})})}),e.jsx(v,{className:"bg-gradient-to-r from-purple-500 to-purple-600 text-white",children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-purple-100 text-sm font-medium",children:"Size Classes"}),e.jsx("p",{className:"text-3xl font-bold",children:P.length})]}),e.jsx(ue,{className:"w-8 h-8 text-purple-200"})]})})})]})}),e.jsxs(v,{className:"hover:shadow-lg transition-shadow",children:[e.jsx(H,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-b",children:e.jsxs(Y,{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(A,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xl font-semibold",children:"Processing Records Ready for Sorting"}),e.jsx("p",{className:"text-sm text-gray-600 font-normal mt-1",children:"Fish that have been processed and are ready to be sorted into size classes"})]})]})}),e.jsx(w,{className:"p-6",children:fe?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ee,{className:"w-8 h-8 animate-spin mx-auto mb-4 text-blue-600"}),e.jsx("p",{className:"text-gray-600",children:"Loading processing records..."})]})}):m.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"p-4 bg-blue-50 rounded-full w-20 h-20 mx-auto mb-4 flex items-center justify-center",children:e.jsx(A,{className:"w-10 h-10 text-blue-400"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Processing Records"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"No fish have been processed yet"}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-gray-500",children:[e.jsx(he,{className:"w-4 h-4"}),e.jsx("span",{children:"Process fish first, then they'll appear here for sorting"})]}),!1]}):e.jsxs("div",{className:"space-y-4",children:[(M?m:m.slice(0,3)).map(s=>e.jsx("div",{className:"group p-6 border border-gray-200 rounded-xl hover:border-blue-300 hover:shadow-md transition-all duration-200 bg-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"p-3 bg-blue-100 rounded-lg group-hover:bg-blue-200 transition-colors",children:e.jsx(E,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsxs("h4",{className:"font-semibold text-gray-900",children:["Processing Record ",s.processing_code||s.id]})}),e.jsxs("div",{className:"flex items-center gap-4 mt-1 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(se,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.post_processing_weight||s.total_weight||0,"kg"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(E,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.ready_for_dispatch_count||s.fish_count||0," fish"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsx("span",{children:new Date(s.processing_date||s.processed_at).toLocaleDateString()})]})]})]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(g,{onClick:()=>ke(s),className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(Te,{className:"w-4 h-4 mr-2"}),"Sort Fish"]})})]})},s.id)),m.length>3&&e.jsx("div",{className:"flex justify-center pt-4",children:e.jsx(g,{variant:"outline",onClick:()=>_e(!M),className:"text-blue-600 border-blue-300 hover:bg-blue-50",children:M?e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"w-4 h-4 mr-2"}),"Show Less"]}):e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"w-4 h-4 mr-2"}),"View All (",m.length," records)"]})})})]})})]}),e.jsxs(v,{className:"hover:shadow-lg transition-shadow",children:[e.jsx(H,{className:"bg-gradient-to-r from-green-50 to-emerald-50 border-b",children:e.jsxs(Y,{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:e.jsx(y,{className:"w-5 h-5 text-green-600"})}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xl font-semibold",children:"Sorted Batches"}),e.jsx("p",{className:"text-sm text-gray-600 font-normal mt-1",children:"Completed sorting operations with size distribution"})]})]})}),e.jsx(w,{className:"p-6",children:u.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"p-4 bg-green-50 rounded-full w-20 h-20 mx-auto mb-4 flex items-center justify-center",children:e.jsx(y,{className:"w-10 h-10 text-green-400"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Sorted Batches"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"No fish have been sorted yet"}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-gray-500",children:[e.jsx(he,{className:"w-4 h-4"}),e.jsx("span",{children:"Sort fish from processing records above to create batches"})]}),!1]}):e.jsxs("div",{className:"space-y-4",children:[(W?u:u.slice(0,3)).map(s=>e.jsx("div",{className:"group p-6 border border-gray-200 rounded-xl hover:border-green-300 hover:shadow-md transition-all duration-200 bg-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"p-3 bg-green-100 rounded-lg group-hover:bg-green-200 transition-colors",children:e.jsx(y,{className:"w-6 h-6 text-green-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsxs("h4",{className:"font-semibold text-gray-900",children:["Sorted Batch #",s.batch_number||s.id.slice(-8).toUpperCase()]})}),e.jsxs("div",{className:"flex items-center gap-4 mt-1 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsxs("span",{children:["Created: ",new Date(s.created_at).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(se,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.total_weight_grams?(s.total_weight_grams/1e3).toFixed(1):0,"kg"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(E,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.total_pieces||0," pieces"]})]}),s.processing_record?.fish_type&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(A,{className:"w-4 h-4"}),e.jsx("span",{children:s.processing_record.fish_type})]})]}),s.processing_record?.warehouse_entry?.farmer&&e.jsx("div",{className:"flex items-center gap-1 mt-2 text-xs text-gray-500",children:e.jsxs("span",{children:["Farmer: ",s.processing_record.warehouse_entry.farmer.name]})})]})]}),e.jsx("div",{className:"flex gap-3",children:e.jsxs(g,{size:"sm",onClick:()=>De(s),className:"bg-orange-600 hover:bg-orange-700 text-white shadow-lg font-medium",children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),"View Details"]})})]})},s.id)),u.length>3&&e.jsx("div",{className:"flex justify-center pt-4",children:e.jsx(g,{variant:"outline",onClick:()=>Ne(!W),className:"text-green-600 border-green-300 hover:bg-green-50",children:W?e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"w-4 h-4 mr-2"}),"Show Less"]}):e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"w-4 h-4 mr-2"}),"View All (",u.length," batches)"]})})})]})})]}),e.jsxs(v,{className:"hover:shadow-lg transition-shadow",children:[e.jsx(H,{className:"bg-gradient-to-r from-green-50 to-emerald-50 border-b",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Y,{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:e.jsx(ue,{className:"w-5 h-5 text-green-600"})}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xl font-semibold",children:"Size Class Thresholds"}),e.jsx("p",{className:"text-sm text-gray-600 font-normal mt-1",children:"Configure weight ranges for each size class (0-10)"})]})]}),e.jsxs(g,{variant:"outline",size:"sm",onClick:ge,children:[e.jsx(Me,{className:"w-4 h-4 mr-2"}),"Manage"]})]})}),e.jsxs(w,{className:"p-6",children:[P.length===0&&!1,e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:P.map(s=>e.jsxs("div",{className:"group p-4 border border-gray-200 rounded-xl hover:border-green-300 hover:shadow-md transition-all duration-200 bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs(G,{variant:"outline",className:`w-16 justify-center font-semibold ${s.class_number<=2?"border-blue-200 text-blue-700 bg-blue-50":s.class_number<=5?"border-green-200 text-green-700 bg-green-50":s.class_number<=8?"border-orange-200 text-orange-700 bg-orange-50":"border-red-200 text-red-700 bg-red-50"}`,children:["Class ",s.class_number]}),e.jsx(g,{variant:"ghost",size:"sm",onClick:ge,children:e.jsx(Ve,{className:"w-4 h-4"})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-1",children:s.description}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(se,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.min_weight_grams,"g - ",s.max_weight_grams===999999.99?"∞":`${s.max_weight_grams}g`]})]})]})]},s.class_number))})]})]}),e.jsx(K,{open:ye,onOpenChange:R,children:e.jsxs(Q,{className:"w-[95vw] max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(J,{children:e.jsx(X,{children:r?"Sorted Batch Details":"Sorting Details"})}),r?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"p-3 bg-gray-50 border border-gray-200 rounded-lg",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2 text-xs text-gray-600",children:[e.jsxs("span",{children:["Data refreshed: ",new Date().toLocaleTimeString()]}),e.jsxs("span",{children:["Batch ID: ",r.id.slice(-8).toUpperCase()]})]})}),e.jsxs("div",{className:"p-4 bg-blue-50 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-3",children:"Batch Information"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-blue-700",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Batch Number:"}),e.jsx("span",{className:"ml-2 font-mono text-xs",children:r.batch_number||r.id.slice(-8).toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Processing Code:"}),e.jsx("span",{className:"ml-2 font-mono text-xs",children:r.processing_record?.processing_code||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Status:"}),e.jsx(G,{variant:"outline",className:"ml-2",children:r.status})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Total Weight:"}),e.jsxs("span",{className:"ml-2 text-green-600 font-semibold",children:[r.total_weight_grams?(r.total_weight_grams/1e3).toFixed(1):0,"kg"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Total Pieces:"}),e.jsx("span",{className:"ml-2 text-green-600 font-semibold",children:r.total_pieces||0})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Created Date:"}),e.jsx("span",{className:"ml-2",children:new Date(r.created_at).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Sorting Date:"}),e.jsx("span",{className:"ml-2",children:new Date(r.sorting_date).toLocaleDateString()})]})]})]}),r.processing_record&&e.jsxs("div",{className:"p-4 bg-purple-50 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-purple-900 mb-3",children:"Processing Record Details"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-purple-700",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Record ID:"}),e.jsx("span",{className:"ml-2 font-mono text-xs",children:r.processing_record.id?.slice(-8).toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Processing Date:"}),e.jsx("span",{className:"ml-2",children:new Date(r.processing_record.processing_date).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Post-Processing Weight:"}),e.jsxs("span",{className:"ml-2 text-green-600 font-semibold",children:[r.processing_record.post_processing_weight||0,"kg"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Ready for Dispatch:"}),e.jsxs("span",{className:"ml-2 text-green-600 font-semibold",children:[r.processing_record.ready_for_dispatch_count||0," pieces"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Fish Type:"}),e.jsx("span",{className:"ml-2",children:r.processing_record.fish_type||"Not specified"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Final Value:"}),e.jsx("span",{className:"ml-2",children:r.processing_record.final_value||"Not specified"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Processing Yield:"}),e.jsxs("span",{className:"ml-2",children:[r.processing_record.processing_yield||0,"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Processing Waste:"}),e.jsxs("span",{className:"ml-2",children:[r.processing_record.processing_waste||0,"kg"]})]})]})]}),r.processing_record?.warehouse_entry?.farmer&&e.jsxs("div",{className:"p-4 bg-orange-50 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-orange-900 mb-3",children:"Farmer Information"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-orange-700",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Farmer Name:"}),e.jsx("span",{className:"ml-2",children:r.processing_record.warehouse_entry.farmer.name})]}),r.processing_record.warehouse_entry.farmer.phone&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Phone:"}),e.jsx("span",{className:"ml-2",children:r.processing_record.warehouse_entry.farmer.phone})]}),r.processing_record.warehouse_entry.farmer.location&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Location:"}),e.jsx("span",{className:"ml-2",children:r.processing_record.warehouse_entry.farmer.location})]}),r.processing_record.warehouse_entry.farmer.rating&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Rating:"}),e.jsxs("span",{className:"ml-2",children:[r.processing_record.warehouse_entry.farmer.rating,"/5"]})]})]})]}),r.storage_location_id&&(()=>{const s=U.find(t=>t.id===r.storage_location_id);return e.jsxs("div",{className:"p-4 bg-indigo-50 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-indigo-900 mb-3",children:"Storage Information"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-indigo-700",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Storage Location:"}),e.jsx("span",{className:"ml-2",children:s?.name||"Unknown Storage"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Stored Date:"}),e.jsx("span",{className:"ml-2",children:new Date(r.created_at).toLocaleDateString()})]})]})]})})(),r.size_distribution&&Object.keys(r.size_distribution).length>0||r.processing_record&&r.processing_record.size_distribution&&Object.keys(r.processing_record.size_distribution).length>0?e.jsxs("div",{children:[e.jsx(_,{className:"text-lg font-semibold",children:"Size Distribution"}),e.jsxs("div",{className:"mt-4 bg-gray-50 rounded-lg p-4",children:[e.jsx("h5",{className:"font-medium text-gray-700 mb-4",children:"Distribution Chart"}),e.jsx("div",{className:"space-y-3",children:Object.entries(r.size_distribution||r.processing_record?.size_distribution||{}).filter(([s,t])=>t>0).sort(([s],[t])=>parseInt(s)-parseInt(t)).map(([s,t])=>{const a=r.total_weight_grams?r.total_weight_grams/1e3:0,l=a>0?t/a*100:0;return e.jsxs("div",{className:"flex items-center gap-2 sm:gap-4",children:[e.jsxs("div",{className:"w-12 sm:w-16 text-sm font-medium text-gray-700",children:["Size ",s]}),e.jsx("div",{className:"flex-1 bg-gray-200 rounded-full h-6 sm:h-8 relative overflow-hidden",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-blue-600 h-full rounded-full transition-all duration-300 flex items-center justify-end pr-2",style:{width:`${Math.min(l,100)}%`},children:l>15&&e.jsxs("span",{className:"text-xs font-medium text-white",children:[t,"kg"]})})}),e.jsxs("div",{className:"text-xs text-gray-600 w-12 text-right",children:[l.toFixed(1),"%"]})]},s)})})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h5",{className:"font-medium text-gray-700 mb-3",children:"Detailed Breakdown"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:Object.entries(r.size_distribution||r.processing_record?.size_distribution||{}).filter(([s,t])=>t>0).sort(([s],[t])=>parseInt(s)-parseInt(t)).map(([s,t])=>{const a=r.total_weight_grams?r.total_weight_grams/1e3:0,l=a>0?t/a*100:0;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg border border-blue-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-200 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"font-bold text-blue-700 text-sm",children:s})}),e.jsxs("div",{children:[e.jsxs("span",{className:"font-semibold text-gray-900",children:["Size ",s]}),e.jsxs("p",{className:"text-xs text-gray-600",children:[l.toFixed(1),"% of total"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("span",{className:"text-lg font-bold text-blue-600",children:[t,"kg"]})})]},s)})})]})]}):e.jsx("div",{className:"p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{className:"w-5 h-5 text-yellow-600"}),e.jsx("span",{className:"text-yellow-800",children:"No size distribution data available for this batch"})]})}),(r.size_distribution&&Object.keys(r.size_distribution).length>0||r.processing_record&&r.processing_record.size_distribution&&Object.keys(r.processing_record.size_distribution).length>0)&&e.jsxs("div",{className:"p-4 bg-green-50 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-green-900 mb-3",children:"Sorting Summary"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-green-700",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Total Sizes:"}),e.jsx("span",{className:"ml-2",children:Object.keys(r.size_distribution||r.processing_record?.size_distribution||{}).length})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Total Distributed:"}),e.jsxs("span",{className:"ml-2 font-semibold",children:[Object.values(r.size_distribution||r.processing_record?.size_distribution||{}).reduce((s,t)=>s+t,0).toFixed(2),"kg"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Largest Size:"}),e.jsxs("span",{className:"ml-2",children:["Size ",Object.entries(r.size_distribution||r.processing_record?.size_distribution||{}).reduce((s,[t,a])=>a>s.weight?{size:t,weight:a}:s,{size:"0",weight:0}).size]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Smallest Size:"}),e.jsxs("span",{className:"ml-2",children:["Size ",Object.entries(r.size_distribution||r.processing_record?.size_distribution||{}).reduce((s,[t,a])=>a<s.weight?{size:t,weight:a}:s,{size:"0",weight:1/0}).size]})]})]})]}),r.notes&&e.jsxs("div",{children:[e.jsx(_,{className:"text-lg font-semibold",children:"Batch Notes"}),e.jsx("div",{className:"mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-yellow-800",children:r.notes})})]}),r.sorted_by_user&&e.jsxs("div",{className:"p-4 bg-orange-50 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-orange-900 mb-3",children:"Sorted By"}),e.jsxs("div",{className:"text-sm text-orange-700",children:[e.jsx("span",{className:"font-medium",children:"User:"}),e.jsx("span",{className:"ml-2",children:r.sorted_by_user.email})]})]})]}):n?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"p-4 bg-blue-50 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-3",children:"Processing Record Details"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm text-blue-700",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Record ID:"}),e.jsx("span",{className:"ml-2 font-mono text-xs",children:n.id?.slice(-8).toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Processing Date:"}),e.jsx("span",{className:"ml-2",children:new Date(n.processing_date).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Total Weight:"}),e.jsxs("span",{className:"ml-2 text-green-600 font-semibold",children:[n.post_processing_weight||0,"kg"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Total Pieces:"}),e.jsx("span",{className:"ml-2 text-green-600 font-semibold",children:n.ready_for_dispatch_count||0})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Fish Type:"}),e.jsx("span",{className:"ml-2",children:n.fish_type||"Not specified"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Final Grade:"}),e.jsx("span",{className:"ml-2",children:n.final_grade||"Not specified"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Processing Yield:"}),e.jsxs("span",{className:"ml-2",children:[n.processing_yield||0,"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Processing Waste:"}),e.jsxs("span",{className:"ml-2",children:[n.processing_waste||0,"kg"]})]})]})]}),e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"Debug Information"}),e.jsxs("div",{className:"text-sm text-gray-600 space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Size Distribution Type:"})," ",typeof n.size_distribution]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Size Distribution Value:"})," ",JSON.stringify(n.size_distribution)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Has Size Distribution:"})," ",n.size_distribution?"Yes":"No"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Size Distribution Keys:"})," ",n.size_distribution?Object.keys(n.size_distribution).join(", "):"None"]})]})]}),n.size_distribution&&Object.keys(n.size_distribution).length>0?e.jsxs("div",{children:[e.jsx(_,{className:"text-lg font-semibold",children:"Size Distribution"}),e.jsxs("div",{className:"mt-4 bg-gray-50 rounded-lg p-4",children:[e.jsx("h5",{className:"font-medium text-gray-700 mb-4",children:"Distribution Chart"}),e.jsx("div",{className:"space-y-3",children:Object.entries(n.size_distribution).filter(([s,t])=>t>0).sort(([s],[t])=>parseInt(s)-parseInt(t)).map(([s,t])=>{const a=n.post_processing_weight>0?t/n.post_processing_weight*100:0;return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"w-16 text-sm font-medium text-gray-700",children:["Size ",s]}),e.jsx("div",{className:"flex-1 bg-gray-200 rounded-full h-8 relative overflow-hidden",children:e.jsxs("div",{className:"bg-gradient-to-r from-green-500 to-green-600 h-full rounded-full transition-all duration-300 flex items-center justify-between px-3",style:{width:`${Math.min(a,100)}%`},children:[e.jsxs("span",{className:"text-sm font-medium text-white",children:[t,"kg"]}),e.jsxs("span",{className:"text-xs text-green-100",children:[a.toFixed(1),"%"]})]})})]},s)})})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h5",{className:"font-medium text-gray-700 mb-3",children:"Detailed Breakdown"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:Object.entries(n.size_distribution).filter(([s,t])=>t>0).sort(([s],[t])=>parseInt(s)-parseInt(t)).map(([s,t])=>{const a=n.post_processing_weight>0?t/n.post_processing_weight*100:0;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gradient-to-r from-green-50 to-green-100 rounded-lg border border-green-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-green-200 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"font-bold text-green-700 text-sm",children:s})}),e.jsxs("div",{children:[e.jsxs("span",{className:"font-semibold text-gray-900",children:["Size ",s]}),e.jsxs("p",{className:"text-xs text-gray-600",children:[a.toFixed(1),"% of total"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("span",{className:"text-lg font-bold text-green-600",children:[t,"kg"]})})]},s)})})]})]}):e.jsxs("div",{className:"p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{className:"w-5 h-5 text-yellow-600"}),e.jsx("span",{className:"text-yellow-800",children:"No size distribution data available for this record"})]}),e.jsx("p",{className:"text-sm text-yellow-700 mt-2",children:"This record may not have been sorted yet, or the size distribution data is missing."})]}),n.size_distribution&&Object.keys(n.size_distribution).length>0?e.jsxs("div",{className:"p-4 bg-green-50 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-green-900 mb-3",children:"Sorting Summary"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm text-green-700",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Total Sizes:"}),e.jsx("span",{className:"ml-2",children:Object.keys(n.size_distribution).length})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Total Distributed:"}),e.jsxs("span",{className:"ml-2 font-semibold",children:[Object.values(n.size_distribution).reduce((s,t)=>s+t,0).toFixed(2),"kg"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Largest Size:"}),e.jsxs("span",{className:"ml-2",children:["Size ",Object.entries(n.size_distribution).reduce((s,[t,a])=>a>s.weight?{size:t,weight:a}:s,{size:"0",weight:0}).size]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Smallest Size:"}),e.jsxs("span",{className:"ml-2",children:["Size ",Object.entries(n.size_distribution).reduce((s,[t,a])=>a<s.weight?{size:t,weight:a}:s,{size:"0",weight:1/0}).size]})]})]})]}):e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-3",children:"Sorting Status"}),e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("p",{children:"This processing record has not been sorted yet."}),e.jsx("p",{className:"mt-2",children:'Use the "Sort Fish" button to distribute the fish into size classes.'})]})]}),(n.notes||n.processing_notes)&&e.jsxs("div",{children:[e.jsx(_,{className:"text-lg font-semibold",children:"Notes & Comments"}),e.jsxs("div",{className:"mt-3 space-y-3",children:[n.notes&&e.jsxs("div",{className:"p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsx("h5",{className:"font-medium text-yellow-900 mb-1",children:"Processing Notes"}),e.jsx("p",{className:"text-sm text-yellow-800",children:n.notes})]}),n.processing_notes&&e.jsxs("div",{className:"p-3 bg-purple-50 border border-purple-200 rounded-lg",children:[e.jsx("h5",{className:"font-medium text-purple-900 mb-1",children:"Additional Notes"}),e.jsx("p",{className:"text-sm text-purple-800",children:n.processing_notes})]})]})]}),n.farmer_name&&e.jsxs("div",{className:"p-4 bg-orange-50 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-orange-900 mb-3",children:"Farmer Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm text-orange-700",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Farmer Name:"}),e.jsx("span",{className:"ml-2",children:n.farmer_name})]}),n.farmer_phone&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Phone:"}),e.jsx("span",{className:"ml-2",children:n.farmer_phone})]}),n.farmer_location&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Location:"}),e.jsx("span",{className:"ml-2",children:n.farmer_location})]}),n.farmer_rating&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Rating:"}),e.jsxs("span",{className:"ml-2",children:[n.farmer_rating,"/5"]})]})]})]})]}):null,e.jsx(Z,{children:e.jsx(g,{variant:"outline",onClick:()=>R(!1),children:"Close"})})]})}),e.jsx(K,{open:we,onOpenChange:B,children:e.jsxs(Q,{className:"sm:max-w-4xl",children:[e.jsx(J,{children:e.jsx(X,{children:"Manage Size Class Thresholds"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Configure the weight ranges for each size class. Fish will be automatically sorted into these classes based on their weight."}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto",children:P.map(s=>e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h4",{className:"font-medium",children:["Class ",s.class_number]}),e.jsx(G,{variant:"outline",children:s.is_active?"Active":"Inactive"})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:s.description}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Range:"})," ",s.min_weight_grams,"g - ",s.max_weight_grams===999999.99?"∞":`${s.max_weight_grams}g`]})]},s.class_number))})]}),e.jsxs(Z,{children:[e.jsx(g,{variant:"outline",onClick:()=>B(!1),children:"Close"}),e.jsx(g,{onClick:()=>B(!1),children:"Save Changes"})]})]})}),e.jsx(K,{open:ve,onOpenChange:T,children:e.jsxs(Q,{className:"w-[95vw] max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(J,{children:[e.jsx(X,{className:"text-xl font-semibold",children:"Sort Fish into Size Classes"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Distribute the processed fish across different size classes"})]}),e.jsxs("div",{className:"space-y-6",children:[n&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(E,{className:"w-5 h-5 text-blue-600"})}),e.jsx("h4",{className:"font-semibold text-blue-900",children:"Processing Record Summary"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700 font-medium",children:"Total Weight:"}),e.jsxs("p",{className:"text-blue-900 font-semibold",children:[n.post_processing_weight||0,"kg"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700 font-medium",children:"Total Pieces:"}),e.jsx("p",{className:"text-blue-900 font-semibold",children:n.ready_for_dispatch_count||0})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700 font-medium",children:"Fish Type:"}),e.jsx("p",{className:"text-blue-900 font-semibold",children:n.fish_type||"Not specified"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700 font-medium",children:"Processing Date:"}),e.jsx("p",{className:"text-blue-900 font-semibold",children:new Date(n.processing_date).toLocaleDateString()})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2",children:[e.jsx("h4",{className:"font-semibold text-gray-900",children:"Size Distribution"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Remaining:"}),e.jsxs("span",{className:`font-medium px-2 py-1 rounded ${i.remaining_weight_kg===0?"bg-green-100 text-green-700":"bg-red-100 text-red-700"}`,children:[i.remaining_weight_kg.toFixed(1),"kg"]})]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3",children:Array.from({length:11},(s,t)=>t).map(s=>{const t=i.size_distribution[s.toString()]||0,a=t>0,l=i.total_weight_kg>0?t/i.total_weight_kg*100:0;return e.jsxs("div",{className:`p-3 rounded-lg border transition-all hover:shadow-sm ${a?"bg-blue-50 border-blue-200 shadow-sm":"bg-gray-50 border-gray-200 hover:border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs(_,{htmlFor:`size-${s}`,className:`text-sm font-medium ${a?"text-blue-700":"text-gray-600"}`,children:["Size ",s]}),a&&e.jsxs("span",{className:"text-xs text-blue-600 font-medium",children:[l.toFixed(1),"%"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Re,{id:`size-${s}`,type:"number",min:"0",max:i.total_weight_kg,step:"0.1",value:t||"",onChange:h=>ze(s.toString(),parseFloat(h.target.value)||0),placeholder:"0.0",className:`flex-1 text-sm ${a?"border-blue-300 focus:border-blue-500 bg-white":"border-gray-200"}`}),e.jsx("span",{className:"text-xs text-gray-500 whitespace-nowrap",children:"kg"})]}),a&&e.jsx("div",{className:"mt-2 w-full bg-gray-200 rounded-full h-1",children:e.jsx("div",{className:"bg-blue-500 h-1 rounded-full transition-all duration-300",style:{width:`${Math.min(l,100)}%`}})})]},s)})}),i.remaining_weight_kg!==0&&e.jsx("div",{className:`p-3 rounded-lg border ${i.remaining_weight_kg>0?"bg-yellow-50 border-yellow-200":"bg-red-50 border-red-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{className:`w-4 h-4 ${i.remaining_weight_kg>0?"text-yellow-600":"text-red-600"}`}),e.jsx("span",{className:`text-sm ${i.remaining_weight_kg>0?"text-yellow-800":"text-red-800"}`,children:i.remaining_weight_kg>0?`${i.remaining_weight_kg.toFixed(1)}kg remaining to distribute`:`Over-distributed by ${Math.abs(i.remaining_weight_kg).toFixed(1)}kg`})]})}),i.remaining_weight_kg===0&&Object.keys(i.size_distribution).filter(s=>i.size_distribution[s]>0).length>0&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(y,{className:"w-4 h-4 text-green-600"}),e.jsxs("span",{className:"text-sm text-green-800",children:["✓ All ",i.total_weight_kg,"kg distributed across ",Object.keys(i.size_distribution).filter(s=>i.size_distribution[s]>0).length," size classes"]})]})})]}),Object.keys(i.size_distribution).filter(s=>i.size_distribution[s]>0).length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-semibold text-gray-900",children:"Distribution Preview"}),e.jsxs("div",{className:"text-sm text-gray-600",children:[Object.keys(i.size_distribution).filter(s=>i.size_distribution[s]>0).length," sizes"]})]}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-100",children:e.jsx("div",{className:"space-y-2",children:Object.entries(i.size_distribution).filter(([s,t])=>t>0).sort(([s],[t])=>parseInt(s)-parseInt(t)).map(([s,t])=>{const a=i.total_weight_kg>0?t/i.total_weight_kg*100:0;return e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"w-10 text-sm font-medium text-gray-700",children:["Size ",s]}),e.jsx("div",{className:"flex-1 bg-white rounded-full h-4 relative overflow-hidden border border-gray-200",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-blue-600 h-full rounded-full transition-all duration-300 flex items-center justify-end pr-2",style:{width:`${Math.min(a,100)}%`},children:a>20&&e.jsxs("span",{className:"text-xs font-medium text-white",children:[t,"kg"]})})}),e.jsxs("div",{className:"text-xs text-gray-600 w-12 text-right font-medium",children:[a.toFixed(1),"%"]})]},s)})})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(_,{htmlFor:"storage-location",className:"text-sm font-medium",children:"Storage Location *"}),e.jsxs(Ie,{value:i.storage_location_id,onValueChange:s=>S({...i,storage_location_id:s}),children:[e.jsx(Ae,{className:"mt-1",children:e.jsx(Ee,{placeholder:"Select storage location"})}),e.jsx(Le,{children:(()=>{const s=U.filter(t=>t.capacity_kg-(t.current_usage_kg||0)>=i.total_weight_kg);return s.length===0?e.jsxs("div",{className:"p-3 text-center text-gray-500 text-sm",children:["No storage locations with adequate space (",i.total_weight_kg,"kg needed)"]}):s.map(t=>{const a=t.capacity_kg-(t.current_usage_kg||0),l=a-i.total_weight_kg;return e.jsx($e,{value:t.id,children:e.jsxs("div",{className:"flex justify-between items-center w-full",children:[e.jsx("span",{className:"text-gray-900",children:t.name}),e.jsxs("span",{className:"text-xs ml-2 text-gray-500",children:[a,"kg available (",l,"kg remaining)"]})]})},t.id)})})()})]}),i.storage_location_id&&(()=>{const s=U.find(l=>l.id===i.storage_location_id);if(!s)return null;const a=s.capacity_kg-(s.current_usage_kg||0)-i.total_weight_kg;return e.jsxs("div",{className:"mt-2 p-2 bg-green-50 border border-green-200 rounded text-xs text-green-700",children:["✓ Adequate space confirmed - ",a,"kg remaining after storage"]})})()]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"sorting-notes",className:"text-sm font-medium",children:"Notes (Optional)"}),e.jsx(qe,{id:"sorting-notes",value:i.notes,onChange:s=>S({...i,notes:s.target.value}),placeholder:"Add any notes about this sorting operation...",rows:3,className:"mt-1"})]})]})]})]}),e.jsxs(Z,{className:"mt-6",children:[e.jsx(g,{variant:"outline",onClick:()=>T(!1),children:"Cancel"}),e.jsx(g,{onClick:Ce,disabled:!!(V||i.remaining_weight_kg!==0||!i.storage_location_id),className:"bg-green-600 hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed",children:V?e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"w-4 h-4 mr-2 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"w-4 h-4 mr-2"}),"Complete Sorting"]})})]})]})})]})})};export{ms as default};
