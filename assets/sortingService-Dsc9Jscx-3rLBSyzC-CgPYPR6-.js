import{j as n,J as c,k as d}from"./index-D0a7Ul_G.js";var m=Object.defineProperty,b=Object.defineProperties,S=Object.getOwnPropertyDescriptors,f=Object.getOwnPropertySymbols,v=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable,y=(l,t,r)=>t in l?m(l,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):l[t]=r,g=(l,t)=>{for(var r in t||(t={}))v.call(t,r)&&y(l,r,t[r]);if(f)for(var r of f(t))E.call(t,r)&&y(l,r,t[r]);return l},p=(l,t)=>b(l,S(t)),s=(l,t,r)=>new Promise((e,i)=>{var o=a=>{try{u(r.next(a))}catch(_){i(_)}},h=a=>{try{u(r.throw(a))}catch(_){i(_)}},u=a=>a.done?e(a.value):Promise.resolve(a.value).then(o,h);u((r=r.apply(l,t)).next())});class z{getSizeClassThresholds(){return s(this,null,function*(){try{const{data:t,error:r}=yield n(()=>s(this,null,function*(){return yield c.from("size_class_thresholds").select("*").eq("is_active",!0).order("class_number")}));return r?(console.warn("Permission denied for size_class_thresholds, returning empty array"),[]):t||[]}catch(t){return console.warn("Error fetching size class thresholds:",t),[]}})}updateSizeClassThresholds(t){return s(this,null,function*(){try{const r=t.map(o=>p(g({},o),{updated_at:new Date().toISOString()})),{data:e,error:i}=yield n(()=>s(this,null,function*(){return yield c.from("size_class_thresholds").upsert(r).select()}));if(i)throw i;return e||[]}catch(r){throw new Error(d(r,"updating size class thresholds"))}})}getSizeClassForWeight(t){return s(this,null,function*(){try{const{data:r,error:e}=yield n(()=>s(this,null,function*(){return yield c.rpc("get_size_class_for_weight",{weight_grams:t})}));if(e)throw e;return r}catch(r){throw new Error(d(r,"determining size class for weight"))}})}createSortingBatch(t){return s(this,null,function*(){try{const{data:r,error:e}=yield n(()=>s(this,null,function*(){return yield c.rpc("create_sorting_batch",{p_processing_record_id:t.processing_record_id,p_batch_number:t.batch_number,p_sorted_by:null,p_storage_location_id:t.storage_location_id||null})}));if(e)throw e;const{data:i,error:o}=yield n(()=>s(this,null,function*(){return yield c.from("sorting_batches").select(`
            *,
            processing_record:processing_records(
              id,
              processing_date,
              post_processing_weight,
              ready_for_dispatch_count,
              processing_code
            )
          `).eq("id",r).single()}));if(o)throw o;return i}catch(r){throw new Error(d(r,"creating sorting batch"))}})}getSortingBatches(t){return s(this,null,function*(){try{let r=c.from("sorting_batches").select(`
          *,
          processing_record:processing_records(
            id,
            processing_date,
            post_processing_weight,
            ready_for_dispatch_count,
            processing_code,
            fish_type,
            grading_results,
            final_value,
            processing_yield,
            processing_waste,
            size_distribution,
            total_pieces,
            warehouse_entry:warehouse_entries(
              id,
              farmer_id,
              farmer:farmers(
                id,
                name,
                phone,
                location,
                rating
              )
            )
          )
        `).order("created_at",{ascending:!1});t!=null&&t.status&&(r=r.eq("status",t.status)),t!=null&&t.processing_record_id&&(r=r.eq("processing_record_id",t.processing_record_id)),t!=null&&t.date_from&&(r=r.gte("sorting_date",t.date_from)),t!=null&&t.date_to&&(r=r.lte("sorting_date",t.date_to));const e=(t==null?void 0:t.limit)||50;r=r.limit(e);const{data:i,error:o}=yield n(()=>s(this,null,function*(){return r}));if(o)throw o;return i||[]}catch(r){throw new Error(d(r,"fetching sorting batches"))}})}getSortingBatch(t){return s(this,null,function*(){try{const{data:r,error:e}=yield n(()=>s(this,null,function*(){return yield c.from("sorting_batches").select(`
            *,
            processing_record:processing_records(
              id,
              processing_date,
              post_processing_weight,
              ready_for_dispatch_count,
              processing_code,
              fish_type,
              grading_results,
              final_value,
              processing_yield,
              processing_waste,
              size_distribution,
              total_pieces,
              warehouse_entry:warehouse_entries(
                id,
                farmer_id,
                farmer:farmers(
                  id,
                  name,
                  phone,
                  location,
                  rating
                )
              )
            )
          `).eq("id",t).single()}));if(e)throw e;const{data:i,error:o}=yield n(()=>s(this,null,function*(){return yield c.from("sorting_results").select("*").eq("sorting_batch_id",t).order("size_class")}));if(o)throw o;return p(g({},r),{results:i||[]})}catch(r){throw new Error(d(r,"fetching sorting batch"))}})}addSortedFishItem(t){return s(this,null,function*(){try{const{data:r,error:e}=yield n(()=>s(this,null,function*(){return yield c.rpc("add_sorted_fish_item",{p_sorting_batch_id:t.sorting_batch_id,p_weight_grams:t.weight_grams,p_length_cm:t.length_cm,p_grade:t.grade,p_quality_notes:t.quality_notes,p_storage_location_id:t.storage_location_id||null})}));if(e)throw e;const{data:i,error:o}=yield n(()=>s(this,null,function*(){return yield c.from("sorted_fish_items").select("*").eq("id",r).single()}));if(o)throw o;return i}catch(r){throw new Error(d(r,"adding sorted fish item"))}})}updateSortingBatch(t,r){return s(this,null,function*(){try{const{data:e,error:i}=yield n(()=>s(this,null,function*(){return yield c.from("sorting_batches").update(p(g({},r),{updated_at:new Date().toISOString()})).eq("id",t).select(`
            *,
            processing_record:processing_records(
              id,
              processing_date,
              post_processing_weight,
              ready_for_dispatch_count,
              processing_code
            )
          `).single()}));if(i)throw i;return e}catch(e){throw new Error(d(e,"updating sorting batch"))}})}completeSortingBatch(t){return s(this,null,function*(){try{const{data:r,error:e}=yield n(()=>s(this,null,function*(){return yield c.rpc("complete_sorting_batch",{p_sorting_batch_id:t})}));if(e)throw e;return r}catch(r){throw new Error(d(r,"completing sorting batch"))}})}getSortingResultsForInventory(t){return s(this,null,function*(){try{const{data:r,error:e}=yield n(()=>s(this,null,function*(){return yield c.rpc("get_sorting_results_for_inventory",{p_sorting_batch_id:t})}));if(e)throw e;return r||[]}catch(r){throw new Error(d(r,"fetching sorting results for inventory"))}})}getSortingSummary(t){return s(this,null,function*(){try{const r=yield this.getSortingBatch(t),e={},i={};let o=0,h=0;r.results.forEach(a=>{e[a.size_class]={pieces:a.total_pieces,weight:a.total_weight_grams,average_weight:a.average_weight_grams},o+=a.total_pieces,h+=a.total_weight_grams,Object.entries(a.grade_distribution).forEach(([_,w])=>{i[_]=(i[_]||0)+w})});const u=r.total_pieces>0?Math.round(o/r.total_pieces*100):0;return{batch_id:r.id,batch_number:r.batch_number,total_items:o,total_weight:h,size_class_distribution:e,grade_distribution:i,completion_percentage:u}}catch(r){throw new Error(d(r,"generating sorting summary"))}})}validateProcessingRecordForSorting(t){return s(this,null,function*(){try{const{data:r,error:e}=yield n(()=>s(this,null,function*(){return yield c.from("processing_records").select("*").eq("id",t).single()}));if(e)throw e;if(!r)return{canSort:!1,reason:"Processing record not found"};const{data:i,error:o}=yield n(()=>s(this,null,function*(){return yield c.from("sorting_batches").select("id, status").eq("processing_record_id",t).eq("status","completed")}));if(o)throw o;return i&&i.length>0&&i[0]?{canSort:!1,reason:"Processing record already sorted"}:!r.post_processing_weight||r.post_processing_weight<=0?{canSort:!1,reason:"Invalid post-processing weight"}:!r.ready_for_dispatch_count||r.ready_for_dispatch_count<=0?{canSort:!1,reason:"No fish ready for dispatch"}:{canSort:!0,processingRecord:r}}catch(r){throw new Error(d(r,"validating processing record for sorting"))}})}getProcessingRecordsReadyForSorting(){return s(this,null,function*(){try{const{data:t,error:r}=yield n(()=>s(this,null,function*(){return yield c.from("processing_records").select(`
            *,
            warehouse_entry:warehouse_entries(
              id,
              entry_date,
              total_weight,
              farmer_id,
              entry_code,
              farmer:farmers(
                id,
                name,
                phone,
                location,
                rating
              )
            ),
            sorting_batches!left(
              id,
              status
            )
          `).gt("post_processing_weight",0).order("processing_date",{ascending:!1})}));if(r)throw r;return(t||[]).filter(e=>{var i;return!((i=e.sorting_batches)!=null&&i.some(o=>o.status==="completed"))})}catch(t){throw new Error(d(t,"fetching processing records ready for sorting"))}})}}const O=new z;export{O};
